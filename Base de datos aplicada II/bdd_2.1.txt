SELECT TO_CHAR(SYSDATE,'YYYYMM') AS ANNIO_MES,
        E.NUMRUN_EMP,
        INITCAP(E.PNOMBRE_EMP||' '||E.SNOMBRE_EMP||' '||E.APPATERNO_EMP||' '||E.APMATERNO_EMP) AS NOMBRE_EMPLEADO,
        E.SUELDO_BASE,
        COUNT(AC.ID_ARRIENDO) AS TOTAL_ARRIENDO_MENSUAL,
        ROUND(E.SUELDO_BASE*(COUNT(AC.ID_ARRIENDO)/100)) AS BONIFICACION_POR_ARRIENDOS

FROM ARRIENDO_CAMION AC
JOIN CAMION C ON (AC.NRO_PATENTE=C.NRO_PATENTE)
JOIN EMPLEADO E ON (C.NUMRUN_EMP=E.NUMRUN_EMP)
WHERE TO_CHAR(AC.FECHA_INI_ARRIENDO,'YYYYMM') = TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM') 
GROUP BY E.NUMRUN_EMP,E.PNOMBRE_EMP,E.SNOMBRE_EMP,E.APPATERNO_EMP,E.APMATERNO_EMP,E.SUELDO_BASE
HAVING COUNT(AC.ID_ARRIENDO) < (SELECT AVG(COUNT(AC.ID_ARRIENDO))
                                FROM ARRIENDO_CAMION AC
                                JOIN CAMION C ON (AC.NRO_PATENTE=C.NRO_PATENTE)
                                JOIN EMPLEADO E ON (C.NUMRUN_EMP=E.NUMRUN_EMP)
                                WHERE TO_CHAR(AC.FECHA_INI_ARRIENDO,'YYYY') = TO_CHAR(SYSDATE,'YYYY')
                                GROUP BY E.NUMRUN_EMP)
ORDER BY APPATERNO_EMP;


--SUBCONSULTA--

SELECT AVG(COUNT(AC.ID_ARRIENDO))
FROM ARRIENDO_CAMION AC
JOIN CAMION C ON (AC.NRO_PATENTE=C.NRO_PATENTE)
JOIN EMPLEADO E ON (C.NUMRUN_EMP=E.NUMRUN_EMP)
WHERE TO_CHAR(AC.FECHA_INI_ARRIENDO,'YYYY') = TO_CHAR(SYSDATE,'YYYY')
GROUP BY E.NUMRUN_EMP;


--INSERCCION DE DATOS--

INSERT INTO BONIF_ARRIENDOS_MENSUAL
SELECT TO_CHAR(SYSDATE,'YYYYMM') AS ANNIO_MES,
        E.NUMRUN_EMP,
        INITCAP(E.PNOMBRE_EMP||' '||E.SNOMBRE_EMP||' '||E.APPATERNO_EMP||' '||E.APMATERNO_EMP) AS NOMBRE_EMPLEADO,
        E.SUELDO_BASE,
        COUNT(AC.ID_ARRIENDO) AS TOTAL_ARRIENDO_MENSUAL,
        ROUND(E.SUELDO_BASE*(COUNT(AC.ID_ARRIENDO)/100)) AS BONIFICACION_POR_ARRIENDOS

FROM ARRIENDO_CAMION AC
JOIN CAMION C ON (AC.NRO_PATENTE=C.NRO_PATENTE)
JOIN EMPLEADO E ON (C.NUMRUN_EMP=E.NUMRUN_EMP)
WHERE TO_CHAR(AC.FECHA_INI_ARRIENDO,'YYYYMM') = TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM') 
GROUP BY E.NUMRUN_EMP,E.PNOMBRE_EMP,E.SNOMBRE_EMP,E.APPATERNO_EMP,E.APMATERNO_EMP,E.SUELDO_BASE
HAVING COUNT(AC.ID_ARRIENDO) < (SELECT AVG(COUNT(AC.ID_ARRIENDO))
                                FROM ARRIENDO_CAMION AC
                                JOIN CAMION C ON (AC.NRO_PATENTE=C.NRO_PATENTE)
                                JOIN EMPLEADO E ON (C.NUMRUN_EMP=E.NUMRUN_EMP)
                                WHERE TO_CHAR(AC.FECHA_INI_ARRIENDO,'YYYY') = TO_CHAR(SYSDATE,'YYYY')
                                GROUP BY E.NUMRUN_EMP)
ORDER BY APPATERNO_EMP;